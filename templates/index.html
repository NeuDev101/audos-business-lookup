{% extends "layout.html" %}

{% block title %}Single Lookup - Audos Lookup{% endblock %}

{% block content %}
<div class="lookup-card">
    <h1 class="card-title">Business Verification</h1>
    <p class="card-subtitle">Enter a corporate number to verify business information</p>
    
    <form method="POST" action="{{ url_for('lookup') }}" class="lookup-form" id="lookupForm">
        <div class="form-group">
            <label for="business_id">Corporate Number</label>
            <input 
                type="text" 
                id="business_id" 
                name="business_id" 
                class="form-input" 
                placeholder="Enter corporate number"
                required
            >
        </div>
        <button type="submit" class="btn btn-primary">Verify Business</button>
    </form>

    <div id="result"></div>

    {% if error %}
    <div class="result-section error-section">
        <h2 class="result-title">Error</h2>
        <p class="error-message">{{ error }}</p>
    </div>
    {% endif %}

    {% if result %}
    <div class="result-section success-section">
        <h2 class="result-title">Verification Result</h2>
        <div class="result-details">
            {% if result.company_name %}
            <div class="detail-row">
                <span class="detail-label">Company Name:</span>
                <span class="detail-value">{{ result.company_name }}</span>
            </div>
            {% endif %}
            
            {% if result.business_id %}
            <div class="detail-row">
                <span class="detail-label">Business ID:</span>
                <span class="detail-value">{{ result.business_id }}</span>
            </div>
            {% endif %}
            
            {% if result.address %}
            <div class="detail-row">
                <span class="detail-label">Address:</span>
                <span class="detail-value">{{ result.address }}</span>
            </div>
            {% endif %}
            
            {% if result.timestamp %}
            <div class="detail-row">
                <span class="detail-label">Verified:</span>
                <span class="detail-value">{{ result.timestamp }}</span>
            </div>
            {% endif %}
        </div>
        
        {% if pdf_url %}
        <div class="result-actions">
            <a href="{{ pdf_url }}" class="btn btn-secondary" download>Download PDF</a>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
(function() {
    const form = document.getElementById('lookupForm');
    const resultDiv = document.getElementById('result');
    
    if (!form || !resultDiv) {
        return;
    }
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const businessIdInput = document.getElementById('business_id');
        const businessId = businessIdInput ? businessIdInput.value.trim() : '';
        
        if (!businessId) {
            resultDiv.innerHTML = '<div class="error">Business ID is required.</div>';
            return;
        }
        
        resultDiv.innerHTML = 'Looking upâ€¦';
        
        fetch('/lookup-single', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ business_id: businessId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                resultDiv.innerHTML = '<div class="error">' + 
                    (data.error === 'internal_server_error' ? 'Internal server error. Please try again.' : data.error) + 
                    '</div>';
            } else {
                let html = '<div class="success"><h2>Verification Result</h2>';
                html += '<div class="result-details">';
                
                if (data.business_id) {
                    html += '<div class="detail-row"><span class="detail-label">Business ID:</span><span class="detail-value">' + 
                        escapeHtml(data.business_id) + '</span></div>';
                }
                
                if (data.name) {
                    html += '<div class="detail-row"><span class="detail-label">Name:</span><span class="detail-value">' + 
                        escapeHtml(data.name) + '</span></div>';
                }
                
                if (data.address) {
                    html += '<div class="detail-row"><span class="detail-label">Address:</span><span class="detail-value">' + 
                        escapeHtml(data.address) + '</span></div>';
                }
                
                if (data.registration_status) {
                    html += '<div class="detail-row"><span class="detail-label">Registration Status:</span><span class="detail-value">' + 
                        escapeHtml(data.registration_status) + '</span></div>';
                }
                
                if (data.timestamp) {
                    html += '<div class="detail-row"><span class="detail-label">Timestamp:</span><span class="detail-value">' + 
                        escapeHtml(data.timestamp) + '</span></div>';
                }
                
                html += '</div></div>';
                resultDiv.innerHTML = html;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div class="error">Network error. Please try again.</div>';
        });
    });
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
})();
</script>
{% endblock %}

